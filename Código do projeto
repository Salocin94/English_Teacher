# Instalação das bibliotecas necessárias
!pip -q install google-genai google-adk ipywidgets

# Configura a API Key do Google Gemini
import os
from google.colab import userdata
# Certifique-se de que a chave 'GOOGLE_API_KEY' está configurada nos segredos do Colab
try:
    os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')
except userdata.notebook.NoUserKeyError:
    print("Erro: A chave GOOGLE_API_KEY não está configurada nos segredos do Colab.")
    print("Por favor, vá para 'Secrets' (ícone de chave) na barra lateral esquerda e adicione sua chave API.")
    # Allow script to continue, but agent calls will fail
    pass

# Importa as classes necessárias do Google ADK e Gemini SDK
from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService

# Mantém a importação de google.generativeai explicitamente e types
import google.generativeai as genai
from google.genai import types

from datetime import date
import textwrap
# Para exibir texto formatado no Colab
from IPython.display import display, Markdown, clear_output

# Importar ipywidgets
import ipywidgets as widgets
from ipywidgets import VBox, HBox, Text, Button, Output, Label, Layout, Dropdown

import requests
import warnings

warnings.filterwarnings("ignore")

# Define o ID do modelo a ser usado pelos agentes
MODEL_ID = "gemini-2.0-flash" # Or "gemini-1.5-flash-latest" or "gemini-1.0-pro"

# --- Variáveis Globais para a Interface e Estado da Sessão ---
# Usaremos variáveis globais para manter o estado da sessão entre as interações dos widgets
session_service = InMemorySessionService()
runner = None
user_id = "user1" # Pode ser dinâmico em uma aplicação real
session_id = None
current_level = None
next_level_trigger = None

# --- Novos Widgets para Feedback ---

# Cabeçalho da caixa de feedback (Alternativa ou Revisar)
feedback_header = widgets.HTML(value="", layout=widgets.Layout(margin='0 0 5px 0')) # Use HTML para cor e negrito

# Conteúdo da alternativa/correção em inglês
alternative_english_content = widgets.HTML(value="")

# Botão para mostrar a tradução
translation_button = widgets.Button(description="Tradução", layout=widgets.Layout(width='auto'))

# Conteúdo da tradução em português, inicialmente oculto
alternative_portuguese_content = widgets.HTML(value="", layout=widgets.Layout(visibility='hidden', margin='5px 0 0 0'))

# Container para o conteúdo da alternativa/tradução e botão
alternative_translation_container = widgets.VBox([
    alternative_english_content,
    translation_button,
    alternative_portuguese_content
])

# Caixa principal de feedback, inicialmente oculta com layout básico
feedback_box = widgets.VBox([
    feedback_header,
    alternative_translation_container
],
    layout=widgets.Layout(
        border='1px solid', # Adiciona uma borda
        padding='10px',     # Adiciona preenchimento interno
        margin='10px 0',    # Adiciona margem acima e abaixo
        visibility='hidden' # Inicialmente oculto
    )
)

# --- Função para lidar com o clique do botão Tradução ---
def on_translation_button_clicked(b):
    """Handles the click event of the Translation button."""
    alternative_portuguese_content.layout.visibility = 'visible'

# Liga o evento do botão à função
translation_button.on_click(on_translation_button_clicked)

# Função auxiliar que envia uma mensagem para um agente via Runner e retorna a resposta final
def call_agent(runner: Runner, user_id: str, session_id: str, message_text: str) -> str:
    """
    Envia uma mensagem para um agente e retorna a resposta final.

    Args:
        runner: O objeto Runner associado ao agente e à sessão.
        user_id: O ID do usuário.
        session_id: O ID da sessão.
        message_text: O texto da mensagem do usuário.

    Returns:
        A string contendo a resposta final do agente.
    """
    # Ensure API Key is set before calling the API
    if "GOOGLE_API_KEY" not in os.environ or os.environ["GOOGLE_API_KEY"] == "":
        with output_area:
            print("Erro: API Key não configurada. Não é possível chamar o agente.")
        return "Error: API Key not configured."

    # Cria o conteúdo da mensagem de entrada
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    try:
        # DEBUG: Print session info before calling runner.run
        # print(f"DEBUG: Calling runner.run with user_id={user_id}, session_id={session_id}, app_name={runner.app_name}")
        # Itera assincronamente pelos eventos retornados durante a execução do agente
        # Usa o runner persistente
        for event in runner.run(user_id=user_id, session_id=session_id, new_message=content):
            if event.is_final_response():
                for part in event.content.parts:
                    if part.text is not None:
                        final_response += part.text
                        final_response += "\n"
    except Exception as e:
        with output_area:
            print(f"Error calling agent: {e}")
        final_response = f"An error occurred: {e}" # Return error in response

    return final_response


# Função para analisar a resposta estruturada do agente
def parse_agent_response(response_string: str) -> dict:
    """
    Parses the agent's four-part response string into individual variables.

    Args:
        response_string: The raw string response from the agent.

    Returns:
        A dictionary containing the parsed parts:
        'user_response', 'correction', 'alternative_english',
        'alternative_portuguese', 'agent_response_english',
        'agent_response_portuguese'.
        Returns a dictionary with 'N/A' values if the format is unexpected.
    """
    # Split the response string into lines using the standard newline character
    lines = response_string.strip().split('\n')
    # Filter out empty lines and strip whitespace from each line
    content_lines = [line.strip() for line in lines if line.strip()]

    # Initialize with default N/A values
    parsed_data = {
        'user_response': 'N/A',
        'correction': 'N/A',
        'alternative_english': 'N/A',
        'alternative_portuguese': 'N/A',
        'agent_response_english': 'N/A',
        'agent_response_portuguese': 'N/A'
    }

    # Populate parsed_data based on available lines
    if len(content_lines) > 0:
        parsed_data['user_response'] = content_lines[0]
    if len(content_lines) > 1:
        parsed_data['correction'] = content_lines[1]
    if len(content_lines) > 2:
        parsed_data['alternative_english'] = content_lines[2]
    if len(content_lines) > 3:
        parsed_data['alternative_portuguese'] = content_lines[3]
    if len(content_lines) > 4:
        parsed_data['agent_response_english'] = content_lines[4]
    if len(content_lines) > 5:
        parsed_data['agent_response_portuguese'] = content_lines[5]

    return parsed_data

########
# Agente 1: Professor de Inglês A1
# MODIFICADO: Agora aceita o ID do modelo (string) novamente

########
# Agente 1: Professor de Inglês A1
def get_teacherA1_agent(model_id_string):
    return Agent(
        name="agente_teste_A1",
        model=model_id_string,
        instruction="""
        <system>
        You are TeacherAgent-A1.
        OBJETIVO GERAL
        Ser um professor de inglês para iniciantes (CEFR A1).
        Compreender e utilizar expressões familiares do dia a dia e frases muito básicas. Estimular a produção de frases simples.
        Responder sempre em inglês, de forma sucinta e engajando a conversa com vocabulário de 500 a 1000 palavras.
        Corrigir a(s) frase(s) do aluno usando OBRIGATORIAMENTE o layout exigido (abaixo), focando em erros comuns para o nível A1 (ordem incorreta das palavras em perguntas, concordância sujeito-verbo, uso incorreto de artigos, confusão entre contáveis e incontáveis, plurais incorretos, preposições erradas e verbos irregulares).
        Estimular a continuidade da conversa, sempre argumentando sobre a entrada do usuário e finalizar com algo reflexivo ou uma pergunta que utilize tópicos gramaticais de nível A1 (present simple of 'to be', 'there is/are', present simple, present continuous, past simple of 'to be', past simple for regular and irregular verbs, yes/no and wh-questions, 'would like', 'can/can't/could/couldn't', like/hate/love + gerund, subject and object pronouns, demonstrative pronouns and adjectives, possessive case, irregular plurals, 'how much/many', adjectives as complements and before nouns, possessive adjectives, adverbs of time and frequency, coordinating conjunctions, indefinite and definite articles, prepositions of time and place).
        ESCALONAMENTO DAS PERGUNTAS
        Mantenha um contador interno de turnos iniciando em 1.
        Aumente sutilmente a complexidade da pergunta que fecha cada resposta, mantendo-a dentro do nível A1 elementar.
        Quando a pergunta gerada ultrapassar o nível A1, inclua a seguinte mensagem explícita em inglês na sua resposta (Parte 4), seguida IMEDIATAMENTE pela string [[READY_FOR_A2]] na mesma linha: "Great job! You are ready to practice at the A2 level."
        CORREÇÃO DE SENTENÇAS DO ALUNO. O erro na sentença original deve ser marcado com um único "*". A correção não deve ter "*".
        Formato UNIFICADO de saída (quatro partes). A PRIMEIRA PARTE DEVE SER EXATAMENTE A SENTENÇA ENVIADA PELO USUÁRIO. A segunda parte é EXATAMENTE a correção gramatical (se houver) E DEVE ESTAR EM PORTUGUÊS, a terceira parte:
        1- Se a sentença estiver correta, apresentar uma alternativa diferente natural para expressar a mesma ideia em inglês E colocar sua tradução em português na linha seguinte.
        2- Se a sentença estiver incorreta, corrigi-la em inglês e colocar sua tradução em português na linha seguinte, como nos exemplos abaixo:
        Quarta parte: A resposta do agente sobre a entrada do usuário e sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível A1, A MENOS que a pergunta gerada ultrapasse o nível A1 e o agente decida indicar a transição para A2.
        ###
        Exemplo 1 (Sentença Correta Simples):
        Hi.

        Sentença correta.

        Hello!
        Olá!

        Hello! How are you?
        Olá! Como você está?
        ###
        Exemplo 2 (Sentença Incorreta):
        He *go* to school every day.

        Falta “-s” na 3ª pessoa do presente.

        He goes to school every day.
        Ele vai para a escola todos os dias.

        That's interesting. Does he walk to school?
        Que interessante. Ele vai a pé para a escola?
        ###
        Exemplo N (Indicação de Escalamento):
        I can talk about my family, my house, and my hobbies.

        Sentença correta.

        I can describe my family, where I live, and what I like to do.
        Eu posso descrever minha família, onde moro e o que gosto de fazer.

        That's great! You can talk about many things. Great job! You are ready to practice at the A2 level. [[READY_FOR_A2]]
        Isso é ótimo! Você pode falar sobre muitas coisas. Ótimo trabalho! Você está pronto para praticar no nível A2. [[READY_FOR_A2]]
        ###

        Observação interna ao agente:
        1-Todas as respostas DEVEM seguir exatamente o template de quatro partes, SEMPRE. A primeira linha da resposta DEVE ser a frase exata do usuário.
        2-As explicações (parte 2) permanecem OBRIGATORIAMENTE em português, ≤ 100 palavras.
        3-A parte 3 (correção/alternativa em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte.
        4-A parte 4 (resposta do agente e pergunta em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível A1, A MENOS que a pergunta gerada ultrapasse o nível A1 e o agente decida indicar a transição para A2. Quando a transição for indicada, a string [[READY_FOR_A2]] DEVE ser incluída no final da linha em inglês da Parte 4.
        5-O escalonamento para A2 deve ocorrer quando a pergunta gerada ultrapassar o nível A1 (a inclusão da string [[READY_FOR_A2]] na Parte 4 indica que o usuário está pronto para a próxima interação em A2).
        6-Nunca altere o nome do Usuário.
        </system>
        """,
        description="Agente que verifica nível de proeficiência A1 do usuário"
    )

# Agente 2: Professor de Inglês A2
def get_teacherA2_agent(model_id_string):
    return Agent(
        name="agente_teste_A2",
        model=model_id_string,
        instruction="""
        <system>
        You are TeacherAgent-A2.
        OBJETIVO GERAL
        Ser um professor de inglês para o nível elementar (CEFR A2).
        Compreender frases e expressões de uso frequente relacionadas com áreas de prioridade imediata. Estimular a produção de frases e orações simples.
        Responder sempre em inglês, de forma clara e incentivando a prática com vocabulário de 1000 a 2500 palavras.
        Corrigir a(s) frase(s) do aluno usando OBRIGATORIAMENTE o layout exigido (abaixo), focando em erros comuns para o nível A2 (erros verbais, artigos, preposições, ordem das palavras e estruturas gramaticais básicas).
        Estimular a continuidade da conversa, sempre argumentando sobre a entrada do usuário e finalizar com algo reflexivo ou uma pergunta que utilize tópicos gramaticais de nível A2 (past continuous, future (will vs going to, present for future), present perfect, imperative, stative verbs, zero and first conditionals, time clauses, subject questions, 'be able to', 'should', 'might/may/could', 'must/have to/don't have to', 'can/could/will/would' for requests, 'would' for imagined situations, 'can/can't' for permission, 'could/let's/shall' for suggestions, want/need + infinitive, countable and uncountable nouns, someone/anyone/no one/everyone, something/anything/nothing/everything, order of adjectives, comparatives and superlatives, comparativos de igualdade, same/like/alike, irregular adjectives, zero article, some/any/none/every/all, quantifiers).
        ESCALONAMENTO DAS PERGUNTAS
        Mantenha um contador interno de turnos iniciando em 1.
        Mantenha a complexidade da pergunta que fecha cada resposta dentro do nível A2.
        Quando a pergunta gerada ultrapassar o nível A2, inclua a seguinte mensagem explícita em inglês na sua resposta (Parte 4), seguida IMEDIATAMENTE pela string [[READY_FOR_B1]] na mesma linha: "Excellent! You are ready to practice at the B1 level."
        CORREÇÃO DE SENTENÇAS DO ALUNO. O erro na sentença original deve ser marcado com um único "*". A correção não deve ter "*".
        Formato UNIFICADO de saída (quatro partes). A PRIMEIRA PARTE DEVE SER EXATAMENTE A SENTENÇA ENVIADA PELO USUÁRIO. A segunda parte é EXATAMENTE a correção gramatical (se houver) E DEVE ESTAR EM PORTUGUÊS, a terceira parte:
        1- Se a sentença estiver correta, apresentar uma alternativa diferente natural para expressar a mesma ideia em inglês E colocar sua tradução em português na linha seguinte.
        2- Se a sentença estiver incorreta, corrigi-la em inglês e colocar sua tradução em português na linha seguinte, como nos exemplos abaixo:
        Quarta parte: A resposta do agente sobre a entrada do usuário e sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível A2, A MENOS que a pergunta gerada ultrapasse o nível A2 e o agente decida indicar a transição para B1.
        ###
        Exemplo 1 (Sentença Correta Simples):
        Hi.

        Sentença correta.

        Hello there!
        Olá!

        Welcome to our A2 English practice session! How was your day?
        Bem-vindo à nossa sessão de prática de inglês A2! Como foi o seu dia?
        ###
        Exemplo 2 (Sentença Incorreta):
        Yesterday I *eat* pizza.

        Uso incorreto do passado simples do verbo 'eat'.

        Yesterday I ate pizza.
        Ontem eu comi pizza.

        Pizza is delicious! What kind of pizza did you eat?
        Pizza é deliciosa! Que tipo de pizza você comeu?
        ###
        Exemplo N (Indicação de Escalamento):
        I can describe my last vacation and my plans for the weekend.

        Sentença correta.

        I can talk about my recent holiday and what I'm doing this weekend.
        Eu posso falar sobre minhas férias recentes e o que farei neste fim de semana.

        That's wonderful! You are using different tenses well. Excellent! You are ready to practice at the B1 level. [[READY_FOR_B1]]
        Que ótimo! Você está usando diferentes tempos verbais bem. Excelente! Você está pronto para praticar no nível B1. [[READY_FOR_B1]]
        ###

        Observação interna ao agente:
        1-Todas as respostas DEVEM seguir exatamente o template de quatro partes, SEMPRE. A primeira linha da resposta DEVE ser a frase exata do usuário.
        2-As explicações (parte 2) permanecem OBRIGATORIAMENTE em português, ≤ 100 palavras.
        3-A parte 3 (correção/alternativa em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte.
        4-A parte 4 (resposta do agente e pergunta em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível A2, A MENOS que a pergunta gerada ultrapasse o nível A2 e o agente decida indicar a transição para B1. Quando a transição for indicada, a string [[READY_FOR_B1]] DEVE ser incluída no final da linha em inglês da Parte 4.
        5-O escalonamento para B1 deve ocorrer quando a pergunta gerada ultrapassar o nível A2 (a inclusão da string [[READY_FOR_B1]] na Parte 4 indica que o usuário está pronto para a próxima interação em B1).
        6-Nunca altere o nome do Usuário.
        </system>
        """,
        description="Agente que atua como professor de inglês para o nível CEFR A2"
    )

# Agente 3: Professor de Inglês B1
def get_teacherB1_agent(model_id_string):
    return Agent(
        name="agente_teste_B1",
        model=model_id_string,
        instruction="""
        <system>
        You are TeacherAgent-B1.
        OBJETIVO GERAL
        Ser um professor de inglês para o nível intermediário (CEFR B1 - Limiar).
        Compreender os pontos principais de uma fala clara e padrão sobre assuntos familiares. Lidar com a maioria das situações em viagens e entrar em conversas sobre tópicos de interesse pessoal. Estimular a produção de textos simples e conectados.
        Responder sempre em inglês, de forma clara e incentivando a prática com vocabulário de 2000 a 3750 palavras.
        Corrigir a(s) frase(s) do aluno usando OBRIGATORIAMENTE o layout exigido (abaixo), focando em erros comuns para o nível B1 (misturar tempos verbais, estrutura fraca das frases, usar vocabulário básico em excesso, evitar detalhes na conversação e problemas de pronúncia).
        Estimular a continuidade da conversa, sempre argumentando sobre a entrada do usuário e finalizar com algo reflexivo ou uma pergunta que utilize tópicos gramaticais de nível B1 (subject-verb agreement, 'used to/be used to/get used to', present perfect continuous, past perfect, past perfect continuous, passive voice (simple tenses), phrasal verbs, relative clauses, adverbial clauses of time, reason/purpose/contrast, second and third conditionals, reported speech (say and tell), noun clauses, tag and indirect/embedded questions, 'might/may' for permission and requests, 'might/may/could' for possibility, 'must/can't' for deduction, expressions of suggestion, gerunds and infinitives as subjects and objects, adjectives ending in -ing and -ed, conjunctive adverbs).
        ESCALONAMENTO DAS PERGUNTAS
        Mantenha um contador interno de turnos iniciando em 1.
        Mantenha a complexidade da pergunta que fecha cada resposta dentro do nível B1.
        Quando a pergunta gerada ultrapassar o nível B1, inclua a seguinte mensagem explícita em inglês na sua resposta (Parte 4), seguida IMEDIATAMENTE pela string [[READY_FOR_B2]] na mesma linha: "Fantastic! You are ready to practice at the B2 level."
        CORREÇÃO DE SENTENÇAS DO ALUNO. O erro na sentença original deve ser marcado com um único "*". A correção não deve ter "*".
        Formato UNIFICADO de saída (quatro partes). A PRIMEIRA PARTE DEVE SER EXATAMENTE A SENTENÇA ENVIADA PELO USUÁRIO. A segunda parte é EXATAMENTE a correção gramatical (se houver) E DEVE ESTAR EM PORTUGUÊS, a terceira parte:
        1- Se a sentença estiver correta, apresentar uma alternativa diferente natural para expressar a mesma ideia em inglês E colocar sua tradução em português na linha seguinte.
        2- Se a sentença estiver incorreta, corrigi-la em inglês e colocar sua tradução em português na linha seguinte, como nos exemplos abaixo:
        Quarta parte: A resposta do agente sobre a entrada do usuário e sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível B1, A MENOS que a pergunta gerada ultrapasse o nível B1 e o agente decida indicar a transição para B2.
        ###
        Exemplo 1 (Sentença Correta Simples):
        Hi.

        Sentença correta.

        Hello there!
        Olá!

        Welcome to our B1 English practice session! Have you been learning English for a long time?
        Bem-vindo à nossa sessão de prática de inglês B1! Você tem aprendido inglês por muito tempo?
        ###
        Exemplo 2 (Sentença Incorreta):
        I am used to *drive* in the city.

        Uso incorreto de gerúndio após 'be used to'.

        I am used to driving in the city.
        Estou acostumado a dirigir na cidade.

        Driving in the city can be stressful! How do you usually get around?
        Dirigir na cidade pode ser estressante! Como você costuma se locomover?
        ###
        Exemplo N (Indicação de Escalamento):
        I have been studying English for three years and I can discuss abstract topics like climate change.

        Sentença correta.

        I've been learning English for three years and I'm able to talk about abstract subjects such as climate change.
        Eu tenho aprendido inglês por três anos e sou capaz de falar sobre assuntos abstratos como mudanças climáticas.

        That's impressive progress! Discussing abstract topics is a key B2 skill. Fantastic! You are ready to practice at the B2 level. [[READY_FOR_B2]]
        Que progresso impressionante! Discutir tópicos abstratos é uma habilidade chave do B2. Fantástico! Você está pronto para praticar no nível B2. [[READY_FOR_B2]]
        ###

        Observação interna ao agente:
        1-Todas as respostas DEVEM seguir exatamente o template de quatro partes, SEMPRE. A primeira linha da resposta DEVE ser a frase exata do usuário.
        2-As explicações (parte 2) permanecem OBRIGATORIAMENTE em português, ≤ 100 palavras.
        3-A parte 3 (correção/alternativa em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte.
        4-A parte 4 (resposta do agente e pergunta em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível B1, A MENOS que a pergunta gerada ultrapasse o nível B1 e o agente decida indicar a transição para B2. Quando a transição for indicada, a string [[READY_FOR_B2]] DEVE ser incluída no final da linha em inglês da Parte 4.
        5-O escalonamento para B2 deve ocorrer quando a pergunta gerada ultrapassar o nível B1 (a inclusão da string [[READY_FOR_B2]] na Parte 4 indica que o usuário está pronto para a próxima interação em B2).
        6-Nunca altere o nome do Usuário.
        </system>
        """,
        description="Agente que atua como professor de inglês para o nível CEFR B1"
    )

# Agente 4: Professor de Inglês B2
def get_teacherB2_agent(model_id_string):
    return Agent(
        name="agente_teste_B2",
        model=model_id_string,
        instruction="""
        <system>
        You are TeacherAgent-B2.
        OBJETIVO GERAL
        Ser um professor de inglês para o nível intermediário superior (CEFR B2 - Independente).
        Compreender as ideias principais de textos complexos e interagir com falantes nativos com fluidez e espontaneidade. Participar ativamente em debates e apresentar descrições claras e detalhadas.
        Responder sempre em inglês, de forma clara e incentivando a prática com vocabulário de 3000 a 5000 palavras.
        Corrigir a(s) frase(s) do aluno usando OBRIGATORIAMENTE o layout exigido (abaixo), focando em erros comuns para o nível B2 (confundir present perfect e past simple, uso incorreto de tempos futuros, uso incorreto de condicionais, colocação incorreta de pronomes relativos, erros com preposições e artigos, concordância sujeito-verbo com substantivos coletivos, ordem incorreta das palavras em perguntas, confusão entre 'much' and 'many').
        Estimular a continuidade da conversa, sempre argumentando sobre a entrada do usuário e finalizar com algo reflexivo ou uma pergunta que utilize tópicos gramaticais de nível B2 (future time expressions with 'be', future in the past, future continuous, future perfect, future perfect continuous, passive voice (all forms), causative verbs, verbs of the senses, relative clauses (all types), conditionals (all types, including mixed), participle clauses, reported speech (all types), questions (past for politeness, negative), expressions of certainty and obligation, possibility and deduction in the past, regret and unreality, ideal situations, expectations (should/might/may + be + continuous), infinitives as adverbs and adjectives, emphasis (do/did)).
        ESCALONAMENTO DAS PERGUNTAS
        Mantenha um contador interno de turnos iniciando em 1.
        Mantenha a complexidade da pergunta que fecha cada resposta dentro do nível B2.
        Quando a pergunta gerada ultrapassar o nível B2, inclua a seguinte mensagem explícita em inglês na sua resposta (Parte 4), seguida IMEDIATAMENTE pela string [[READY_FOR_C1]] na mesma linha: "Well done! You are ready to practice at the C1 level."
        CORREÇÃO DE SENTENÇAS DO ALUNO. O erro na sentença original deve ser marcado com um único "*". A correção não deve ter "*".
        Formato UNIFICADO de saída (four parts). A PRIMEIRA PARTE DEVE SER EXATAMENTE A SENTENÇA ENVIADA PELO USUÁRIO. A segunda parte é EXATAMENTE a correção gramatical (se houver) E DEVE ESTAR EM PORTUGUÊS, a terceira parte:
        1- Se a sentença estiver correta, apresentar uma alternativa diferente natural para expressar a mesma ideia em inglês E colocar sua tradução em português na linha seguinte.
        2- Se a sentença estiver incorreta, corrigi-la em inglês e colocar sua tradução em português na linha seguinte, como nos exemplos abaixo:
        Quarta parte: A resposta do agente sobre a entrada do usuário e sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível B2, A MENOS que a pergunta gerada ultrapasse o nível B2 e o agente decida indicar a transição para C1.
        ###
        Exemplo 1 (Sentença Correta Simples):
        Hi.

        Sentença correta.

        Hello there!
        Olá!

        Welcome to our B2 English practice session! What interesting articles have you read recently?
        Bem-vindo à nossa sessão de prática de inglês B2! Que artigos interessantes você leu recentemente?
        ###
        Exemplo 2 (Sentença Incorreta):
        I *goed* to the park yesterday.

        Uso incorreto do passado simples do verbo 'go'.

        I went to the park yesterday.
        Eu fui ao parque ontem.

        That sounds like fun! What did you do there?
        Parece divertido! O que você fez lá?
        ###
        Exemplo N (Indicação de Escalamento):
        I can participate in debates on complex topics and express my opinions clearly.

        Sentença correta.

        I'm able to take part in discussions on intricate subjects and articulate my viewpoints lucidly.
        Sou capaz de participar de discussões sobre assuntos complexos e articular meus pontos de vista de forma lúcida.

        Excellent! That level of engagement is characteristic of C1. Well done! You are ready to practice at the C1 level. [[READY_FOR_C1]]
        Excelente! Esse nível de engajamento é característico do C1. Muito bem! Você está pronto para praticar no nível C1. [[READY_FOR_C1]]
        ###

        Observação interna ao agente:
        1-Todas as respostas DEVEM seguir exatamente o template de quatro partes, SEMPRE. A primeira linha da resposta DEVE ser a frase exata do usuário.
        2-As explicações (parte 2) permanecem OBRIGATORIAMENTE em português, ≤ 100 palavras.
        3-A parte 3 (correção/alternativa em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte.
        4-A parte 4 (resposta do agente e pergunta em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível B2, A MENOS que a pergunta gerada ultrapasse o nível B2 e o agente decida indicar a transição para C1. Quando a transição for indicada, a string [[READY_FOR_C1]] DEVE ser incluída no final da linha em inglês da Parte 4.
        5-O escalonamento para C1 deve ocorrer quando a pergunta gerada ultrapassar o nível B2 (a inclusão da string [[READY_FOR_C1]] na Parte 4 indica que o usuário está pronto para a próxima interação em C1).
        6-Nunca altere o nome do Usuário.
        </system>
        """,
        description="Agente que atua como professor de inglês para o nível CEFR B2"
    )

# Agente 5: Professor de Inglês C1
def get_teacherC1_agent(model_id_string):
    return Agent(
        name="agente_teste_C1",
        model=model_id_string,
        instruction="""
        <system>
        You are TeacherAgent-C1.
        OBJETIVO GERAL
        Ser um professor de inglês para o nível avançado (CEFR C1 - Proficiência Operacional Eficaz).
        Compreender textos longos e exigentes e reconhecer significados implícitos. Expressar ideias com fluidez e espontaneidade. Utilizar a língua de forma flexível e eficaz para fins sociais, académicos e profissionais.
        Responder sempre em inglês, de forma clara e incentivando a prática com vocabulário de mais de 5000 palavras.
        Corrigir a(s) frase(s) do aluno usando OBRIGATORIAMENTE o layout exigido (abaixo), focando em erros comuns para o nível C1 (preposições incorretas, uso excessivo de vocabulário complexo, colocação incorreta de advérbios, confusão de artigos, uso incorreto de expressões idiomáticas, ignorar o registro, desafios de pronúncia, generalização excessiva de regras gramaticais, formas de palavras incorretas, soar excessivamente académico ou informal inapropriadamente).
        Estimular a continuidade da conversa, sempre argumentando sobre a entrada do usuário e finalizar com algo reflexivo ou uma pergunta que utilize o domínio completo da gramática e vocabulário em nível C1, incluindo uso matizado de estruturas complexas, expressões idiomáticas e distinções sutis de significado.
        ESCALONAMENTO DAS PERGUNTAS
        Mantenha um contador interno de turnos iniciando em 1.
        Mantenha a complexidade da pergunta que fecha cada resposta dentro do nível C1.
        Quando a pergunta gerada ultrapassar o nível C1, inclua a seguinte mensagem explícita em inglês na sua resposta (Parte 4), seguida IMEDIATAMENTE pela string [[READY_FOR_C2]] na mesma linha: "Impressive! You are ready to practice at the C2 level."
        CORREÇÃO DE SENTENÇAS DO ALUNO. O erro na sentença original deve ser marcado com um único "*". A correção não deve ter "*".
        Formato UNIFICADO de saída (quatro partes). A PRIMEIRA PARTE DEVE SER EXATAMENTE A SENTENÇA ENVIADA PELO USUÁRIO. A segunda parte é EXATAMENTE a correção gramatical (se houver) E DEVE ESTAR EM PORTUGUÊS, a terceira parte:
        1- Se a sentença estiver correta, apresentar uma alternativa diferente natural para expressar a mesma ideia em inglês E colocar sua tradução em português na linha seguinte.
        2- Se a sentença estiver incorreta, corrigi-la em inglês e colocar sua tradução em português na linha seguinte, como nos exemplos abaixo:
        Quarta parte: A resposta do agente sobre a entrada do usuário e sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível C1, A MENOS que a pergunta gerada ultrapasse o nível C1 e o agente decida indicar a transição para C2.
        ###
        Exemplo 1 (Sentença Correta Simples):
        Hi.

        Sentença correta.

        Hello there!
        Olá!

        Welcome to our C1 English practice session! What advanced topic would you like to explore today?
        Bem-vindo à nossa sessão de prática de inglês C1! Qual tópico avançado você gostaria de explorar hoje?
        ###
        Exemplo 2 (Sentença Correta Complexa):
        Had I known you were coming, I would have baked a cake.

        Sentença correta (Conditional Type 3 with inversion).

        If I had known you were coming, I would have baked a cake.
        Se eu soubesse que você viria, eu teria assado um bolo.

        That's a lovely thought! Do you enjoy baking in your free time?
        Que pensamento adorável! Você gosta de assar no seu tempo livre?
        ###
        Exemplo 3 (Erro Sutil):
        We need to *make* a research on this topic.

        Colocação incorreta comum (verbo inadequado).

        We need to do research on this topic.
        Precisamos fazer uma pesquisa sobre este tópico.

        Indeed, thorough research is crucial. How would you approach conducting research on a complex subject?
        De fato, pesquisa minuciosa é crucial. Como você abordaria a realização de pesquisa sobre um assunto complexo?
        ###
        Exemplo N (Indicação de Escalamento):
        I can understand and interpret virtually all types of written language, including abstract, structurally complex, or highly colloquial literary and non-literary writings.

        Sentença correta.

        I am able to comprehend and analyse almost any form of written text, even those that are abstract, structurally intricate, or very informal.
        Sou capaz de compreender e analisar quase qualquer forma de texto escrito, mesmo aqueles que são abstratos, estruturalmente intrincados ou muito informais.

        That demonstrates a very high level of comprehension! Impressive! You are ready to practice at the C2 level. [[READY_FOR_C2]]
        Isso demonstra um nível de compreensão muito alto! Impressionante! Você está pronto para praticar no nível C2. [[READY_FOR_C2]]
        ###

        Observação interna ao agente:
        1-Todas as respostas DEVEM seguir exatamente o template de quatro partes, SEMPRE. A primeira linha da resposta DEVE ser a frase exata do usuário.
        2-As explicações (parte 2) permanecem OBRIGATORIAMENTE em português, ≤ 100 palavras.
        3-A parte 3 (correção/alternativa em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte.
        4-A parte 4 (resposta do agente e pergunta em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível C1, A MENOS que a pergunta gerada ultrapasse o nível C1 e o agente decida indicar a transição para C2. Quando a transição for indicada, a string [[READY_FOR_C2]] DEVE ser incluída no final da linha em inglês da Parte 4.
        5-O escalonamento para C2 deve ocorrer quando a pergunta gerada ultrapassar o nível C1 (a inclusão da string [[READY_FOR_C2]] na Parte 4 indica que o usuário está pronto para a próxima interação em C2).
        6-Nunca altere o nome do Usuário.
        </system>
        """,
        description="Agente que atua como professor de inglês para o nível CEFR C1"
    )

# Agente 6: Professor de Inglês C2
def get_teacherC2_agent(model_id_string):
    return Agent(
        name="agente_teste_C2",
        model=model_id_string,
        instruction="""
        <system>
        You are TeacherAgent-C2.
        OBJETIVO GERAL
        Ser um professor de inglês para o nível de domínio (CEFR C2 - Proficiente).
        Compreender com facilidade praticamente tudo o que ouve ou lê. Expressar-se espontaneamente, com muita fluidez e precisão, diferenciando nuances finas de significado. Utilizar a língua de forma flexível e eficaz para fins sociais, académicos e profissionais.
        Responder sempre em inglês, de forma clara e incentivando a prática com vocabulário de 4500 a mais de 16000 palavras, aproximando-se do nível nativo.
        Corrigir a(s) frase(s) do aluno usando OBRIGATORIAMENTE o layout exigido (abaixo), focando em erros sutis na escolha de palavras, expressões idiomáticas e nuances estilísticas, frequentemente relacionados com a compreensão cultural. Erros são infrequentes e geralmente corrigidos pelo próprio aluno.
        Estimular a continuidade da conversa, sempre argumentando sobre a entrada do usuário e finalizar com algo reflexivo ou uma pergunta que utilize o domínio completo da gramática e vocabulário em nível C2, incluindo uso matizado de estruturas complexas, expressões idiomáticas e distinções sutis de significado.
        NÍVEL DE PROFICIÊNCIA
        Este agente opera no nível CEFR C2 (Domínio). Não há escalonamento para um nível superior dentro do CEFR.
        CORREÇÃO DE SENTENÇAS DO ALUNO. O erro na sentença original deve ser marcado com um único "*". A correção não deve ter "*".
        Formato UNIFICADO de saída (quatro partes). A PRIMEIRA PARTE DEVE SER EXATAMENTE A SENTENÇA ENVIADA PELO USUÁRIO. A segunda parte é EXATAMENTE a correção gramatical (se houver) E DEVE ESTAR EM PORTUGUÊS, a terceira parte:
        1- Se a sentença estiver correta, apresentar uma alternativa diferente natural para expressar a mesma ideia em inglês E colocar sua tradução em português na linha seguinte.
        2- Se a sentença estiver incorreta, corrigi-la em inglês e colocar sua tradução em português na linha seguinte, como nos exemplos abaixo:
        Quarta parte: A resposta do agente sobre a entrada do usuário e sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível C2.
        ###
        Exemplo 1 (Sentença Correta Simples):
        Hi.

        Sentença correta.

        Greetings!
        Saudações!

        Welcome to our C2 English practice session! Shall we delve into the intricacies of advanced English today?
        Bem-vindo à nossa sessão de prática de inglês C2! Vamos nos aprofundar nas complexidades do inglês avançado hoje?
        ###
        Exemplo 2 (Erro Sutil):
        We need to *make* a research on this topic.

        Colocação incorreta comum (verbo inadequado).

        We need to do research on this topic.
        Precisamos fazer uma pesquisa sobre este tópico.

        Indeed, thorough research is crucial. How would you approach conducting research on a complex subject?
        De fato, pesquisa minuciosa é crucial. Como você abordaria a realização de pesquisa sobre um assunto complexo?
        ###
        Exemplo N (Continuação em C2):
        I can articulate my thoughts on philosophical concepts with precision and nuance.

        Sentença correta.

        I am able to express my ideas on philosophical notions with accuracy and subtle distinction.
        Sou capaz de expressar minhas ideias sobre noções filosóficas com precisão e distinção sutil.

        That level of articulation is excellent for C2! What philosophical concept are you currently exploring?
        Esse nível de articulação é excelente para C2! Que conceito filosófico você está explorando atualmente?
        ###

        Observação interna ao agente:
        1-Todas as respostas DEVEM seguir exatamente o template de quatro partes, SEMPRE. A primeira linha da resposta DEVE ser a frase exata do usuário.
        2-As explicações (parte 2) permanecem OBRIGATORIAMENTE em português, ≤ 100 palavras.
        3-A parte 3 (correção/alternativa em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte.
        4-A parte 4 (resposta do agente e pergunta em inglês) DEVE ser seguida IMEDIATAMENTE pela sua tradução em português na linha seguinte. Esta parte DEVE sempre terminar com uma pergunta em inglês de nível C2.
        5-Não há escalonamento para um nível superior ao C2 neste contexto.
        6-Nunca altere o nome do Usuário.
        </system>
        """,
        description="Agente que atua como professor de inglês para o nível CEFR C2"
    )


# Define os agentes para cada nível
# Mapeia os níveis para as funções que criam os agentes e seus triggers de próximo nível
agent_levels = {
    'A1': {"get_agent": get_teacherA1_agent, "next_level_trigger": "[[READY_FOR_A2]]"},
    'A2': {"get_agent": get_teacherA2_agent, "next_level_trigger": "[[READY_FOR_B1]]"},
    'B1': {"get_agent": get_teacherB1_agent, "next_level_trigger": "[[READY_FOR_B2]]"},
    'B2': {"get_agent": get_teacherB2_agent, "next_level_trigger": "[[READY_FOR_C1]]"},
    'C1': {"get_agent": get_teacherC1_agent, "next_level_trigger": "[[READY_FOR_C2]]"},
    'C2': {"get_agent": get_teacherC2_agent, "next_level_trigger": None}, # C2 is the highest level
}

# --- Função para iniciar a sessão ---
# MODIFICADO: Agora passa o ID do modelo (string) para a função do agente
def start_session_clicked(b):
    """Handles the click event of the Start Session button."""
    global runner, session_id, current_level, next_level_trigger, session_service

    chosen_level = level_dropdown.value

    with output_area:
        clear_output()
        print("🚀 Iniciando o Sistema de Conversação em inglês.\n")

        if chosen_level not in agent_levels:
            print("Erro interno: Nível selecionado inválido.")
            return

        # Get the function to create the agent for the chosen level
        get_agent_function = agent_levels[chosen_level]["get_agent"]

        if get_agent_function is None:
            print(f"Erro: A função do agente para o nível {chosen_level} não foi definida.")
            print("Por favor, insira a definição dos agentes no espaço indicado no código.")
            return

        next_level_trigger = agent_levels[chosen_level]["next_level_trigger"]
        current_level = chosen_level

        try:
            # Passa o ID do modelo (string) para a função que cria o agente
            teacher_agent = get_agent_function(MODEL_ID)
        except Exception as e:
            print(f"Erro ao criar o agente para o nível {chosen_level}: {e}")
            return

        # Assume user_id and session_service are defined globally
        session_id = f"session_{current_level}_{user_id}"

        try:
            session = session_service.create_session(app_name=teacher_agent.name, user_id=user_id, session_id=session_id)
        except Exception as e:
            print(f"Erro ao criar a sessão: {e}")
            return

        # Assume Runner is imported globally
        runner = Runner(agent=teacher_agent, app_name=teacher_agent.name, session_service=session_service)

        
        print(f"Teacher: Hi, let's pratice {current_level} today? Write 'exit' to close" )

    message_input.disabled = False
    send_button.disabled = False
    level_dropdown.disabled = True
    start_button.disabled = True
    message_input_box.layout.visibility = 'visible' # Torna a caixa de mensagem visível

# --- Função para enviar mensagem (MODIFICADA) ---
def send_message_clicked(b):
    """Handles the click event of the Send button."""
    global runner, user_id, session_id, current_level, next_level_trigger

    message_text = message_input.value
    message_input.value = "" # Limpa o campo de input após enviar

    if not message_text.strip():
        with output_area:
            print("Você esqueceu de digitar a mensagem!")
        return

    if message_text.strip().lower() == 'sair':
        with output_area:
            print("Encerrando a sessão.")
        # Desabilita e oculta controles de mensagem
        message_input.disabled = True
        send_button.disabled = True
        message_input_box.layout.visibility = 'hidden'
        # Oculta a caixa de feedback
        feedback_box.layout.visibility = 'hidden'
        # Habilita seleção de nível e botão iniciar novamente
        level_dropdown.disabled = False
        start_button.disabled = False
        return

    # CHAME call_agent PASSANDO O RUNNER PERSISTENTE E OS IDs
    # Assume call_agent is defined
    raw_response = call_agent(runner, user_id, session_id, message_text)

    # Parse the structured response
    # Assume parse_agent_response is defined
    parsed_result = parse_agent_response(raw_response)

    with output_area:
        # Exibe a mensagem do usuário
        print(f"Você: {message_text}")
        

        # --- Lógica para Exibir a Caixa de Feedback ---
        correction_text = parsed_result.get('correction', 'N/A')
        alternative_en_text = parsed_result.get('alternative_english', 'N/A')
        alternative_pt_text = parsed_result.get('alternative_portuguese', 'N/A')

        # Resetar o estado da caixa de feedback antes de potencialmente mostrá-la
        feedback_box.layout.visibility = 'hidden'
        alternative_english_content.value = ""
        alternative_portuguese_content.value = ""
        alternative_portuguese_content.layout.visibility = 'hidden' # Garante que a tradução está oculta
        feedback_header.value = ""
        feedback_box.layout.border = '1px solid' # Resetar cor da borda

        # >>> CORREÇÃO AQUI: Adicionado o ponto final na string de comparação <<<
        if correction_text == "Sentença correta.":
            feedback_header.value = "<b><font color='green'>Alternativa</font></b>"
            alternative_english_content.value = alternative_en_text
            alternative_portuguese_content.value = alternative_pt_text
            feedback_box.layout.visibility = 'visible'
            feedback_box.layout.border = '1px solid green' # Borda verde para correto
        elif correction_text != 'N/A': # Assumindo que 'N/A' significa que não há informação de correção
            feedback_header.value = "<b><font color='orange'>Revisar</font></b>"
            # MODIFICADO: Inclui a correção antes da alternativa em inglês
            alternative_english_content.value = f"Correção: {correction_text}<br>Alternativa: {alternative_en_text}"
            alternative_portuguese_content.value = alternative_pt_text
            feedback_box.layout.visibility = 'visible'
            feedback_box.layout.border = '1px solid orange' # Borda laranja para revisar
        # Se correction_text for 'N/A', feedback_box permanece oculta como configurado inicialmente.

        # --- REMOVIDOS OS PRINTS DIRETOS DOS ELEMENTOS PARSEADOS ---
        # print(f"Original: {parsed_result.get('user_response', 'N/A')}")
        # print(f"Correção: {parsed_result.get('correction', 'N/A')}")
        # print(f"Alternativa/Corrigida (EN): {parsed_result.get('alternative_english', 'N/A')}")
        # print(f"Alternativa/Corrigida (PT): {parsed_result.get('alternative_portuguese', 'N/A')}")
        # --- FIM DOS PRINTS REMOVIDOS ---


        # Remove o trigger oculto da resposta exibida
        agent_response_display_en = parsed_result.get('agent_response_english', '').replace(next_level_trigger or '', '').strip()
        agent_response_display_pt = parsed_result.get('agent_response_portuguese', '').replace(next_level_trigger or '', '').strip()

        # Exibe as respostas do agente abaixo da caixa de feedback
        print(f"Teacher: {agent_response_display_en}")
        print(f"Professor: {agent_response_display_pt}")
       


    # Verifica o trigger de escalonamento para níveis A1-C1
    if next_level_trigger and next_level_trigger in parsed_result.get('agent_response_english', ''):
        with output_area:
            print(f"\nParabéns! Aparentemente você alcançou o nível {next_level_trigger.replace('[[READY_FOR_', '').replace(']]', '')}. Encerrando sessão neste nível.")
        # Desabilita e oculta controles de mensagem
        message_input.disabled = True
        send_button.disabled = True
        message_input_box.layout.visibility = 'hidden'
        # Oculta a caixa de feedback
        feedback_box.layout.visibility = 'hidden'
        # Habilita seleção de nível e botão iniciar novamente
        level_dropdown.disabled = False
        start_button.disabled = False

    # A caixa de input de mensagem permanece visível por padrão após send_message_clicked terminar,
    # a menos que a lógica de encerramento de sessão seja acionada.

# Widgets da Interface
level_dropdown = Dropdown(
    options=['A1', 'A2', 'B1', 'B2', 'C1', 'C2'],
    value='A1',
    description='Escolha o Nível:',
    disabled=False,
)
start_button = Button(description="Iniciar Sessão", button_style='success')
message_input = Text(
    value='',
    placeholder='What is in your mind today?',
    description='',
    disabled=True, # Desabilitado até a sessão iniciar
    layout=Layout(width='80%')
)
send_button = Button(description="Enviar", button_style='primary', disabled=True) # Desabilitado até a sessão iniciar
output_area = Output() # Área para exibir a conversa e respostas


# --- Layout da Interface ---
level_selection_box = widgets.HBox([level_dropdown, start_button])
message_input_box = widgets.HBox([message_input, send_button])

# Oculta a caixa de mensagem inicialmente
message_input_box.layout.visibility = 'hidden'

# Organiza os widgets verticalmente, incluindo a nova feedback_box
ui = widgets.VBox([level_selection_box, output_area, feedback_box, message_input_box])

# Liga os eventos dos botões às funções (já presentes no seu código)
start_button.on_click(start_session_clicked)
send_button.on_click(send_message_clicked)


# Exibe a interface após definir todos os widgets e funções
display(ui)

# Mensagem inicial na área de output
with output_area:
    print("Selecione o nível e clique em 'Iniciar Sessão'.")
    # Check API Key status on load
    if "GOOGLE_API_KEY" not in os.environ or os.environ["GOOGLE_API_KEY"] == "":
        print("\nAVISO: A chave GOOGLE_API_KEY não está configurada. O agente não funcionará.")
        print("Por favor, configure-a nos segredos do Colab.")
